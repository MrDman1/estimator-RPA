<Page x:Class="Nuform.App.Views.ResultsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      mc:Ignorable="d">
  <Grid Margin="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header / Actions -->
    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
      <TextBlock Text="Estimate Results" FontSize="20" FontWeight="Bold" VerticalAlignment="Center"/>
      <StackPanel Orientation="Horizontal" Margin="12,0,0,0">
        <Button Content="Open Calculations" Command="{Binding OpenCalculationsCommand}" Margin="0,0,8,0"/>
        <Button Content="Export PDF" Command="{Binding ExportPdfCommand}" Margin="0,0,8,0"/>
        <Button Content="Export CSV" Command="{Binding ExportCsvCommand}" Margin="0,0,8,0"/>
        <Button Content="Export SOF" Command="{Binding ExportSofCommand}" />
      </StackPanel>
    </StackPanel>

    <!-- Warning -->
    <Border Grid.Row="1" CornerRadius="4" Padding="8" Background="#FFFDEEB4" BorderBrush="#FFE9C46A" BorderThickness="1"
            Visibility="{Binding ShowOverageWarning, Converter={StaticResource BoolToVisibility}}">
      <TextBlock Text="Rounded total exceeds +7.5% of base. Adjust Extras or proceed."
                 Foreground="#7A5A00" />
    </Border>

    <!-- Summary and BOM -->
    <StackPanel Grid.Row="2" Margin="0,12,0,12">
      <!-- Summary cards -->
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Border Margin="4" Padding="12" Background="#FFF7F7F7" BorderBrush="#FFE0E0E0" BorderThickness="1">
          <StackPanel>
            <TextBlock Text="Base Panels" FontWeight="SemiBold"/>
            <TextBlock Text="{Binding BasePanels}" FontSize="18"/>
          </StackPanel>
        </Border>

        <Border Grid.Column="1" Margin="4" Padding="12" Background="#FFF7F7F7" BorderBrush="#FFE0E0E0" BorderThickness="1">
          <StackPanel>
            <TextBlock Text="Extras (%)" FontWeight="SemiBold"/>
            <DockPanel>
              <TextBox Width="60" Text="{Binding ExtrasPercentText, UpdateSourceTrigger=PropertyChanged}" />
              <TextBlock Margin="6,0,0,0" Text="%" VerticalAlignment="Center"/>
            </DockPanel>
          </StackPanel>
        </Border>

        <Border Grid.Column="2" Margin="4" Padding="12" Background="#FFF7F7F7" BorderBrush="#FFE0E0E0" BorderThickness="1">
          <StackPanel>
            <TextBlock Text="Rounded Panels" FontWeight="SemiBold"/>
            <TextBlock Text="{Binding RoundedPanels}" FontSize="18"/>
          </StackPanel>
        </Border>

        <Border Grid.Column="3" Margin="4" Padding="12" Background="#FFF7F7F7" BorderBrush="#FFE0E0E0" BorderThickness="1">
          <StackPanel>
            <TextBlock Text="Overage (%)" FontWeight="SemiBold"/>
            <TextBlock Text="{Binding OveragePercentRounded, StringFormat={}{0:N1}%}" FontSize="18"/>
          </StackPanel>
        </Border>
      </Grid>

      <!-- BOM Table -->
      <DataGrid ItemsSource="{Binding BillOfMaterials}" AutoGenerateColumns="False" IsReadOnly="False" Margin="0,12,0,0">
        <DataGrid.Columns>
          <DataGridTextColumn Header="Part #" Binding="{Binding PartNumber}" IsReadOnly="True" Width="*" />
          <DataGridTextColumn Header="Name"   Binding="{Binding Name}"       IsReadOnly="True" Width="2*" />
          <DataGridTextColumn Header="Suggested" Binding="{Binding SuggestedQty, StringFormat={}{0:N2}}" IsReadOnly="True" Width="Auto" />
          <DataGridTextColumn Header="Change" Binding="{Binding Change, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
          <DataGridTextColumn Header="Final"  Binding="{Binding FinalQty, StringFormat={}{0:N2}}" IsReadOnly="True" Width="Auto" />
          <DataGridTextColumn Header="Unit"   Binding="{Binding Unit}" Width="Auto" />
          <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="Auto" />
        </DataGrid.Columns>
      </DataGrid>
    </StackPanel>

    <!-- Footer -->
    <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
      <Button Content="Back" Command="{Binding BackCommand}" Margin="0,0,8,0"/>
      <Button Content="Reset" Command="{Binding ResetCommand}" Margin="0,0,8,0"/>
      <Button Content="Finish" Command="{Binding FinishCommand}"/>
    </StackPanel>
  </Grid>
</Page>
